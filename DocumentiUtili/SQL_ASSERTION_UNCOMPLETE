--Le Assertion sono state tratte come Trigger

--Essendo trigger iniziamo con le Procedure

--Prima Procedura

CREATE OR REPALCE FUNCTION No_Povery_Ascolta() RETURNS TRIGGER AS $N_P_A$

BEGIN
CHECK NOT EXIST NEW.NickName (non so sicuro) IN (SELECT Nickaname
					     FROM ASCOLTA AS A,
						  TRACCIA AS T,
						  UTENTE AS U
					     WHERE U.NickName=A.NickName AND T.CodT=A.CodT AND T.Qualita>128 AND U.IsPremium=FALSE
						);
RETURN XXX;
END $N_P_A$ LANGUAGE PLPGSQL;

--Seconda Procedura
CREATE OR REPLACE FUNCTION No_Povery_Vota() RETURNS TRIGGER AS $N_P_V$

BEGIN
CHECK NOT EXIST NEW.NickName (non sono sicuro) IN (SELECT NickName
						   FROM VOTA AS V,
							UTENTE AS U,
						   WHERE U.Nickanme=V.NickName AND U.IsPremium=FALSE);
RETURN XXX;
END $N_P_V$ LANGUAGE PLPGSQL;

--Terza Procedura
CREATE OR REPLACE FUNCTION Cover_Not_Original() RETURNS TRIGGER AS $C_N_O$

BEGIN
CHECK NOT EXIST NEW.CodT (non sono sicuro) IN(SELECT CodT
					      FROM TRACCIA AS T1
					      WHERE T1.IsCover AND
						     T1.CodT IN (SELECT CodT
								 FROM TRACCIA AS T2,
								      PRODUCE AS P1,
								      PRODUCE AS P2
								 WHERE  T1.Titolo=T2.Titolo AND
									T2.IsCover=FALSE AND
									P1.Codt=T1.CodT AND
									P2.CodT=T2.CodT AND
									P1.NomeArte=P2.NomeArte));
RETURNS XXX;
END $C_N_O$ LANGUAGE PLPGSQL;

--Passiamo ora alla creazione dei Trigger che useranno propriamente queste procedure(formando cosi le nostre Assertion)

--Il primo Trigger controlla che non esisti un Utente non Premium che ascolti tracce di qualita superiore a 128 (stu spuorc)

CREATE OR REPLACE TRIGGER Quality_Check
BEFORE INSERT INTO ASCOLTA -- Credo sia sbagliato ma nn mi viene niente di piu sensato in mente (perche beofre grazie al cazzo ceh nn ce, ma after nn deve esserci quindi dovrei evitare ceh ci sia,quindi o al afteer si puo puoi fare che se succede poi delte elsenn socome cazzo fare)
FOR EACH ROW
EXECUTE PROCEDURE No_Povery_Ascolta();

--Il secondo Trigger controlla che non esistino voti per tracce da Utente non Premium (sti muort e famm)
CREATE OR REPLACE TRIGGER Democracy_Check
BEFORE INSERT INTO VOTA (stessa cosa di quello sopra)
FOR EACH ROW
EXECUTE PROCEDURE No_Povery_Vota();

--Il terzo Trigger controlla che la cover nn sia prodotta dagli stessi artisti del originale
CREATE OR REPLACE TRIGGER Cover_Check
BEFORE INSERT INTO PRODUCE (hai capito)
FOR EACH ROW
EXECUTE PROCEDURE Cover_Not_Original();
--69 NICE
