CREATE DB PINOFY;

CREATE TABLE ALBUM (
	CodA SERIAL,
	Titolo VARCHAR(50) NOT NULL,
	AnnoU INTEGER NOT NULL,
	Durata TIME DEFAULT '00:00:00',
	Ntracce INTEGER DEFAULT 0,
	Etichetta VARCHAR(20) DEFAULT NULL,
	Voto INTEGER DEFAULT 0,
	
	PRIMARY KEY (CodA)
);


CREATE TABLE TRACCIA (
	CodT SERIAL,
	Titolo VARCHAR(50) NOT NULL,
	Durata TIME NOT NULL,
	Etichetta VARCHAR(20) DEFAULT NULL,
	AnnoU INTEGER,
	IsCover BOOLEAN DEFAULT FALSE,
	IsRemastered BOOLEAN DEFAULT FALSE,
	Genere VARCHAR(30) NOT NULL,
	Link VARCHAR(300),
	Formato VARCHAR(4) DEFAULT 'MP3',
	Voto INTEGER DEFAULT 0,
	Qualita INTEGER DEFAULT 128,
	CodA SERIAL DEFAULT 1,
	CodTR SERIAL DEFAULT 1,
	CodTC SERIAL DEFAULT 1,
	
	UNIQUE(Titolo, AnnoU, CodA),
	PRIMARY KEY (CodT),
	FOREIGN KEY (CodA) REFERENCES Album(CodA),
	FOREIGN KEY (CodTR) REFERENCES Traccia(CodT),
	FOREIGN KEY (CodTC) REFERENCES Traccia(CodT),
	
	CHECK (Formato = 'MP3' or Formato = 'WAV' or Formato = 'FLAC'),
	CHECK (Qualita = 128 or Qualita = 256 or Qualita = 512)
);


CREATE TABLE UTENTE (
	NickName VARCHAR(20),
	Nome VARCHAR(30) NOT NULL,
	Cognome VARCHAR(30) NOT NULL,
	Email VARCHAR(100) NOT NULL,
	Password VARCHAR(20) NOT NULL,
	DataN DATE NOT NULL,
	Sesso VARCHAR(15) NOT NULL,
	Nazionalita VARCHAR(15) DEFAULT NULL,
	Descrizione VARCHAR(100) DEFAULT NULL,
	IsPremium BOOLEAN DEFAULT FALSE,
	IsAdmin BOOLEAN DEFAULT FALSE,

	PRIMARY KEY (NickName),
	
	UNIQUE(Email),
	CHECK (Email LIKE '_%@_%._%'),
	CHECK (Sesso = 'Uomo' or Sesso = 'Donna' or Sesso = 'Altro' or Sesso = 'Transgender'or Sesso = 'Lampadina' or Sesso = 'Unicorno')
);


CREATE TABLE PLAYLIST(
	CodP SERIAL,
	Titolo VARCHAR(20) NOT NULL,
	Durata TIME DEFAULT '00:00:00',
	NTracce INTEGER DEFAULT 0,
	Visibilita BOOLEAN DEFAULT TRUE,
	NickName VARCHAR(20),
	
	PRIMARY KEY (CodP),
	FOREIGN KEY (NickName) REFERENCES UTENTE(NickName)
);


CREATE TABLE ASCOLTA (
	Nickname VARCHAR(20),
	CodT SERIAL,
	FasciaOraria INTEGER NOT NULL,
	
	FOREIGN KEY (NickName) REFERENCES UTENTE(NickName),
	FOREIGN KEY (CodT) REFERENCES TRACCIA(CodT),
	
	CHECK(FasciaOraria >= 1 and FasciaOraria <= 6) 
);

CREATE TABLE VOTA (
	NickName VARCHAR(20),
	CodT SERIAL,
	Voto INTEGER NOT NULL,
	
	FOREIGN KEY (NickName) REFERENCES UTENTE(NickName),
	FOREIGN KEY (CodT) REFERENCES TRACCIA(CodT),	
	
	CHECK(Voto >= 1 and Voto <= 10)
);


CREATE TABLE CONTIENE (
	CodP SERIAL,
	CodT SERIAL,

	FOREIGN KEY (CodT) REFERENCES TRACCIA(CodT),
	FOREIGN KEY (CodP) REFERENCES PLAYLIST(CodP)
);


CREATE TABLE ARTISTA (
	NomeArte VARCHAR(30),
	Descrizione VARCHAR(300) DEFAULT NULL,
	Voto INTEGER DEFAULT 0,

	PRIMARY KEY(NomeArte)
);

CREATE TABLE INCIDE (
	NomeArte VARCHAR(30),
	CodA SERIAL,
	
	FOREIGN KEY (NomeArte) REFERENCES ARTISTA(NomeArte),
	FOREIGN KEY (CodA) REFERENCES ALBUM(CodA)
);

CREATE TABLE PRODUCE (
	NomeArte VARCHAR(30),
	CodT SERIAL,
	
	FOREIGN KEY (NomeArte) REFERENCES ARTISTA(NomeArte),
	FOREIGN KEY (CodT) REFERENCES TRACCIA(CodT)
);
