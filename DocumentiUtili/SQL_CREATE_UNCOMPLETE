CREATE TABLE ALBUM (
	CodA SERIAL,
	Titolo VARCHAR(50) NOT NULL,
	AnnoU INTEGER NOT NULL,
	Durata TIME DEFAULT '00:00:00',
	Ntracce INTEGER DEFAULT 0,
	Etichetta VARCHAR(20) DEFAULT NULL,
	Voto INTEGER DEFAULT 0,
	
	PRIMARY KEY (CodA)
);


CREATE TABLE TRACCIA (
	CodT SERIAL,
	Titolo VARCHAR(50) NOT NULL,
	Durata TIME NOT NULL,
	Etichetta VARCHAR(20) DEFAULT NULL,
	AnnoU INTEGER,
	IsCover BOOLEAN DEFAULT FALSE,
	IsRemastered BOOLEAN DEFAULT FALSE,
	Genere VARCHAR(30) NOT NULL,
	Link VARCHAR(300),
	Formato VARCHAR(4) DEFAULT 'MP3',
	Voto INTEGER DEFAULT 0,
	Qualita INTEGER DEFAULT 128,
	CodA INTEGER DEFAULT 0,
	CodTR INTEGER DEFAULT 0,
	CodTC INTEGER DEFAULT 0,
	
	UNIQUE(Titolo, AnnoU, CodA),
	PRIMARY KEY (CodT),
	FOREIGN KEY (CodA) REFERENCES Album(CodA)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY (CodTR) REFERENCES Traccia(CodT)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY (CodTC) REFERENCES Traccia(CodT)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	
	CHECK (Formato = 'MP3' or Formato = 'WAV' or Formato = 'FLAC'),
	CHECK (Qualita = 128 or Qualita = 256 or Qualita = 512)
);


CREATE TABLE UTENTE (
	NickName VARCHAR(20),
	Nome VARCHAR(30) NOT NULL,
	Cognome VARCHAR(30) NOT NULL,
	Email VARCHAR(100) NOT NULL,
	Password VARCHAR(20) NOT NULL,
	DataN DATE NOT NULL,
	Sesso VARCHAR(15) NOT NULL,
	Nazionalita VARCHAR(15) DEFAULT NULL,
	Descrizione VARCHAR(100) DEFAULT NULL,
	IsPremium BOOLEAN DEFAULT FALSE,
	IsAdmin BOOLEAN DEFAULT FALSE,

	PRIMARY KEY (NickName),
	
	UNIQUE(Email),
	CHECK (Email LIKE '_%@_%._%'),
	CHECK (Sesso = 'Uomo' or Sesso = 'Donna' or Sesso = 'Altro' or Sesso = 'Transgender'or Sesso = 'Lampadina' or Sesso = 'Unicorno')
);


CREATE TABLE PLAYLIST(
	CodP SERIAL,
	Titolo VARCHAR(20) NOT NULL,
	Durata TIME DEFAULT '00:00:00',
	NTracce INTEGER DEFAULT 0,
	Visibilita BOOLEAN DEFAULT TRUE,
	NickName VARCHAR(20),
	
	PRIMARY KEY (CodP),
	FOREIGN KEY (NickName) REFERENCES UTENTE(NickName)
		ON DELETE CASCADE
		ON UPDATE CASCADE
);


CREATE TABLE ASCOLTA (
	Nickname VARCHAR(20),
	CodT INTEGER,
	FasciaOraria INTEGER NOT NULL,
	
	FOREIGN KEY (NickName) REFERENCES UTENTE(NickName)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY (CodT) REFERENCES TRACCIA(CodT)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	
	CHECK(FasciaOraria >= 1 and FasciaOraria <= 6) 
);

CREATE TABLE VOTA (
	NickName VARCHAR(20),
	CodT INTEGER,
	Voto INTEGER NOT NULL,
	
	UNQUE(NickName, CodT),
	
	FOREIGN KEY (NickName) REFERENCES UTENTE(NickName)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY (CodT) REFERENCES TRACCIA(CodT)
		ON DELETE CASCADE
		ON UPDATE CASCADE,	
	
	CHECK(Voto >= 1 and Voto <= 10)
);

CREATE TABLE CONTIENE (
	CodP INTEGER,
	CodT INTEGER,
	
	UNIQUE(CodP, CodT),
	
	FOREIGN KEY (CodT) REFERENCES TRACCIA(CodT)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY (CodP) REFERENCES PLAYLIST(CodP)
		ON DELETE CASCADE
		ON UPDATE CASCADE
);


CREATE TABLE ARTISTA (
	NomeArte VARCHAR(30),
	Descrizione VARCHAR(300) DEFAULT NULL,
	Voto INTEGER DEFAULT 0,

	PRIMARY KEY(NomeArte)
);

CREATE TABLE INCIDE (
	NomeArte VARCHAR(30),
	CodA INTEGER,
	
	UNIQUE(NomeArte, CodA),
	FOREIGN KEY (NomeArte) REFERENCES ARTISTA(NomeArte)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY (CodA) REFERENCES ALBUM(CodA)
		ON DELETE CASCADE
		ON UPDATE CASCADE
);

CREATE TABLE PRODUCE (
	NomeArte VARCHAR(30),
	CodT INTEGER,
	
	UNIQUE(NomeArte, CodT),
	FOREIGN KEY (NomeArte) REFERENCES ARTISTA(NomeArte)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY (CodT) REFERENCES TRACCIA(CodT)
		ON DELETE CASCADE
		ON UPDATE CASCADE
);
